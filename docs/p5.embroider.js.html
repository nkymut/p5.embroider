<!DOCTYPE html><html lang="en" style="font-size:16px"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Source: p5.embroider.js</title><!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]--><script src="scripts/third-party/hljs.js" defer="defer"></script><script src="scripts/third-party/hljs-line-num.js" defer="defer"></script><script src="scripts/third-party/popper.js" defer="defer"></script><script src="scripts/third-party/tippy.js" defer="defer"></script><script src="scripts/third-party/tocbot.min.js"></script><script>var baseURL="/",locationPathname="";baseURL=(locationPathname=document.location.pathname).substr(0,locationPathname.lastIndexOf("/")+1)</script><link rel="stylesheet" href="styles/clean-jsdoc-theme.min.css"><svg aria-hidden="true" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" style="display:none"><defs><symbol id="copy-icon" viewbox="0 0 488.3 488.3"><g><path d="M314.25,85.4h-227c-21.3,0-38.6,17.3-38.6,38.6v325.7c0,21.3,17.3,38.6,38.6,38.6h227c21.3,0,38.6-17.3,38.6-38.6V124    C352.75,102.7,335.45,85.4,314.25,85.4z M325.75,449.6c0,6.4-5.2,11.6-11.6,11.6h-227c-6.4,0-11.6-5.2-11.6-11.6V124    c0-6.4,5.2-11.6,11.6-11.6h227c6.4,0,11.6,5.2,11.6,11.6V449.6z"/><path d="M401.05,0h-227c-21.3,0-38.6,17.3-38.6,38.6c0,7.5,6,13.5,13.5,13.5s13.5-6,13.5-13.5c0-6.4,5.2-11.6,11.6-11.6h227    c6.4,0,11.6,5.2,11.6,11.6v325.7c0,6.4-5.2,11.6-11.6,11.6c-7.5,0-13.5,6-13.5,13.5s6,13.5,13.5,13.5c21.3,0,38.6-17.3,38.6-38.6    V38.6C439.65,17.3,422.35,0,401.05,0z"/></g></symbol><symbol id="search-icon" viewBox="0 0 512 512"><g><g><path d="M225.474,0C101.151,0,0,101.151,0,225.474c0,124.33,101.151,225.474,225.474,225.474    c124.33,0,225.474-101.144,225.474-225.474C450.948,101.151,349.804,0,225.474,0z M225.474,409.323    c-101.373,0-183.848-82.475-183.848-183.848S124.101,41.626,225.474,41.626s183.848,82.475,183.848,183.848    S326.847,409.323,225.474,409.323z"/></g></g><g><g><path d="M505.902,476.472L386.574,357.144c-8.131-8.131-21.299-8.131-29.43,0c-8.131,8.124-8.131,21.306,0,29.43l119.328,119.328    c4.065,4.065,9.387,6.098,14.715,6.098c5.321,0,10.649-2.033,14.715-6.098C514.033,497.778,514.033,484.596,505.902,476.472z"/></g></g></symbol><symbol id="font-size-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11.246 15H4.754l-2 5H.6L7 4h2l6.4 16h-2.154l-2-5zm-.8-2L8 6.885 5.554 13h4.892zM21 12.535V12h2v8h-2v-.535a4 4 0 1 1 0-6.93zM19 18a2 2 0 1 0 0-4 2 2 0 0 0 0 4z"/></symbol><symbol id="add-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M11 11V5h2v6h6v2h-6v6h-2v-6H5v-2z"/></symbol><symbol id="minus-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M5 11h14v2H5z"/></symbol><symbol id="dark-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M10 7a7 7 0 0 0 12 4.9v.1c0 5.523-4.477 10-10 10S2 17.523 2 12 6.477 2 12 2h.1A6.979 6.979 0 0 0 10 7zm-6 5a8 8 0 0 0 15.062 3.762A9 9 0 0 1 8.238 4.938 7.999 7.999 0 0 0 4 12z"/></symbol><symbol id="light-theme-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 18a6 6 0 1 1 0-12 6 6 0 0 1 0 12zm0-2a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM11 1h2v3h-2V1zm0 19h2v3h-2v-3zM3.515 4.929l1.414-1.414L7.05 5.636 5.636 7.05 3.515 4.93zM16.95 18.364l1.414-1.414 2.121 2.121-1.414 1.414-2.121-2.121zm2.121-14.85l1.414 1.415-2.121 2.121-1.414-1.414 2.121-2.121zM5.636 16.95l1.414 1.414-2.121 2.121-1.414-1.414 2.121-2.121zM23 11v2h-3v-2h3zM4 11v2H1v-2h3z"/></symbol><symbol id="reset-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M18.537 19.567A9.961 9.961 0 0 1 12 22C6.477 22 2 17.523 2 12S6.477 2 12 2s10 4.477 10 10c0 2.136-.67 4.116-1.81 5.74L17 12h3a8 8 0 1 0-2.46 5.772l.997 1.795z"/></symbol><symbol id="down-icon" viewBox="0 0 16 16"><path fill-rule="evenodd" clip-rule="evenodd" d="M12.7803 6.21967C13.0732 6.51256 13.0732 6.98744 12.7803 7.28033L8.53033 11.5303C8.23744 11.8232 7.76256 11.8232 7.46967 11.5303L3.21967 7.28033C2.92678 6.98744 2.92678 6.51256 3.21967 6.21967C3.51256 5.92678 3.98744 5.92678 4.28033 6.21967L8 9.93934L11.7197 6.21967C12.0126 5.92678 12.4874 5.92678 12.7803 6.21967Z"></path></symbol><symbol id="codepen-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M16.5 13.202L13 15.535v3.596L19.197 15 16.5 13.202zM14.697 12L12 10.202 9.303 12 12 13.798 14.697 12zM20 10.869L18.303 12 20 13.131V10.87zM19.197 9L13 4.869v3.596l3.5 2.333L19.197 9zM7.5 10.798L11 8.465V4.869L4.803 9 7.5 10.798zM4.803 15L11 19.131v-3.596l-3.5-2.333L4.803 15zM4 13.131L5.697 12 4 10.869v2.262zM2 9a1 1 0 0 1 .445-.832l9-6a1 1 0 0 1 1.11 0l9 6A1 1 0 0 1 22 9v6a1 1 0 0 1-.445.832l-9 6a1 1 0 0 1-1.11 0l-9-6A1 1 0 0 1 2 15V9z"/></symbol><symbol id="close-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M12 10.586l4.95-4.95 1.414 1.414-4.95 4.95 4.95 4.95-1.414 1.414-4.95-4.95-4.95 4.95-1.414-1.414 4.95-4.95-4.95-4.95L7.05 5.636z"/></symbol><symbol id="menu-icon" viewBox="0 0 24 24"><path fill="none" d="M0 0h24v24H0z"/><path d="M3 4h18v2H3V4zm0 7h18v2H3v-2zm0 7h18v2H3v-2z"/></symbol></defs></svg></head><body data-theme="dark"><div class="sidebar-container"><div class="sidebar" id="sidebar"><div class="sidebar-items-container"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="DSTWriter.html">DSTWriter</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#beginRecord">beginRecord</a></div><div class="sidebar-section-children"><a href="global.html#endRecord">endRecord</a></div><div class="sidebar-section-children"><a href="global.html#exportDST">exportDST</a></div><div class="sidebar-section-children"><a href="global.html#exportEmbroidery">exportEmbroidery</a></div><div class="sidebar-section-children"><a href="global.html#exportGcode">exportGcode</a></div><div class="sidebar-section-children"><a href="global.html#mmToPixel">mmToPixel</a></div><div class="sidebar-section-children"><a href="global.html#pixelToMm">pixelToMm</a></div><div class="sidebar-section-children"><a href="global.html#setDrawMode">setDrawMode</a></div><div class="sidebar-section-children"><a href="global.html#setStitch">setStitch</a></div><div class="sidebar-section-children"><a href="global.html#trimThread">trimThread</a></div></div></div></div></div><div class="navbar-container" id="VuAckcnZhf"><nav class="navbar"><div class="navbar-left-items"></div><div class="navbar-right-items"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div><nav></nav></nav></div><div class="toc-container"><div class="toc-content"><span class="bold">On this page</span><div id="eed4d2a0bfd64539bb9df78095dec881"></div></div></div><div class="body-wrapper"><div class="main-content"><div class="main-wrapper"><section id="source-page" class="source-page"><header><h1 id="title" class="has-anchor">p5.embroider.js</h1></header><article><pre class="prettyprint source lang-js"><code>import { DSTWriter } from "./p5-tajima-dst-writer.js";
import { GCodeWriter } from "./p5-gcode-writer.js";

(function (global) {
  const p5embroidery = {};

  // Internal properties
  let _p5Instance;
  let _recording = false;
  let _drawMode = "stitch"; // 'stitch', 'p5', 'realistic'
  let _stitchData = {
    width: 0,
    height: 0,
    threads: [],
    pixelsPerUnit: 1,
    stitchCount: 0,
  };
  let _currentThreadIndex = 0;

  // Embroidery settings
  const _embrSettings = {
    stitchLength: 3, // mm
    minStitchLength: 1, // mm
    resampleNoise: 0, // 0-1 range
    minimumPathLength: 0,
    maximumJoinDistance: 0,
    maximumStitchesPerSquareMm: 0,
    jumpThreshold: 10, // mm
    units: "mm",
  };

  /**
   * Thread class for storing color and stitch data.
   * @private
   */
  class Thread {
    /**
     * Creates a new Thread instance.
     * @param {number} r - Red component (0-255)
     * @param {number} g - Green component (0-255)
     * @param {number} b - Blue component (0-255)
     */
    constructor(r, g, b) {
      this.red = r;
      this.green = g;
      this.blue = b;
      this.runs = [];
    }
  }

  /**
   * Begins recording embroidery data.
   * @method beginRecord
   * @for p5
   * @param {p5} p5Instance - The p5.js sketch instance
   * @example
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   // Draw embroidery patterns here
   *   endRecord();
   * }
   */
  p5embroidery.beginRecord = function (p5Instance) {
    if (!p5Instance) {
      throw new Error("Invalid p5 instance provided to beginRecord().");
    }
    _p5Instance = p5Instance;
    _stitchData.width = p5Instance.width;
    _stitchData.height = p5Instance.height;
    _stitchData.threads = [new Thread(0, 0, 0)]; // Start with a default black thread
    _recording = true;
    overrideP5Functions();
  };

  /**
   * Ends recording and prepares for export.
   * @method endRecord
   * @for p5
   * @example
   * 
   * 
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   // Draw embroidery patterns
   *   endRecord();
   * }
   * 
   * 
   */
  p5embroidery.endRecord = function () {
    _recording = false;
    restoreP5Functions();
    //exportEmbroidery(format);
  };

  /**
   * Overrides p5.js line() function to record embroidery stitches.
   * @private
   */
  let _originalLineFunc;
  function overrideLineFunction() {
    _originalLineFunc = window.line;
    window.line = function (x1, y1, x2, y2) {
      if (_recording) {
        let stitches = convertLineToStitches(x1, y1, x2, y2);
        _stitchData.threads[_currentThreadIndex].runs.push(stitches);

        if (
          _drawMode === "stitch" ||
          _drawMode === "realistic" ||
          _drawMode === "p5"
        ) {
          drawStitches(stitches);
        } else {
          _originalLineFunc.call(
            this,
            mmToPixel(x1),
            mmToPixel(y1),
            mmToPixel(x2),
            mmToPixel(y2),
          );
        }
      } else {
        _originalLineFunc.apply(this, arguments);
      }
    };
  }

  /**
   * Overrides p5.js ellipse() function to record embroidery stitches.
   * @private
   */
  let _originalEllipseFunc;
  function overrideEllipseFunction() {
    _originalEllipseFunc = window.ellipse;
    window.ellipse = function (x, y, w, h) {
      if (_recording) {

        // Calculate radius values
        let radiusX = w / 2;
        let radiusY = h / 2;

        // Generate stitch points for the ellipse
        let stitches = [];
        let numSteps = Math.max(Math.ceil(Math.PI * (radiusX + radiusY) / _embrSettings.stitchLength), 12);
        
        // Generate points along the ellipse
        for (let i = 0; i &lt;= numSteps; i++) {
          let angle = (i / numSteps) * Math.PI * 2;
          let stitchX = x + Math.cos(angle) * radiusX;
          let stitchY = y + Math.sin(angle) * radiusY;
          
          // Store in tenths of mm (internal format)
          stitches.push({
            x: stitchX * 10,
            y: stitchY * 10
          });
        }

        // Record the stitches if we're recording
        if (_recording) {
          // Get the current position (in tenths of mm)
          let currentX, currentY;
          if (_stitchData.threads[_currentThreadIndex].runs.length === 0 ||
              _stitchData.threads[_currentThreadIndex].runs[_stitchData.threads[_currentThreadIndex].runs.length - 1].length === 0) {
            // If there are no runs or the last run is empty, use the center of the ellipse as the starting point
            currentX = x * 10; // Convert to tenths of mm
            currentY = y * 10; // Convert to tenths of mm
          } else {
            // Otherwise, use the last stitch position (already in tenths of mm)
            let lastRun = _stitchData.threads[_currentThreadIndex].runs[_stitchData.threads[_currentThreadIndex].runs.length - 1];
            let lastStitch = lastRun[lastRun.length - 1];
            currentX = lastStitch.x;
            currentY = lastStitch.y;
          }

          // Add a jump stitch to the first point of the ellipse if needed
          if (Math.sqrt(Math.pow(stitches[0].x - currentX, 2) + Math.pow(stitches[0].y - currentY, 2)) > _embrSettings.jumpThreshold) {
            _stitchData.threads[_currentThreadIndex].runs.push([
              {
                x: currentX,
                y: currentY,
                command: "jump"
              },
              {
                x: stitches[0].x,
                y: stitches[0].y
              }
            ]);
          }

          // Add the ellipse stitches
          _stitchData.threads[_currentThreadIndex].runs.push(stitches);
        }


        // Call drawStitches with the correct format
        drawStitches(stitches); // Convert back to mm for drawStitches

        // Call the original ellipse function if in p5 mode
        if (_drawMode === "p5") {
          _originalEllipseFunc.call(this, mmToPixel(x), mmToPixel(y), mmToPixel(w), mmToPixel(h));
        }
      } else {
        _originalEllipseFunc.apply(this, arguments);
      }
    };
  }

  /**
   * Overrides necessary p5.js functions for embroidery recording.
   * @private
   */
  function overrideP5Functions() {
    overrideLineFunction();
    overrideEllipseFunction();
    // Add more overrides as needed
  }

  /**
   * Restores original p5.js functions.
   * @private
   */
  function restoreP5Functions() {
    window.line = _originalLineFunc;
    window.ellipse = _originalEllipseFunc;
    // Restore other functions as needed
  }

  /**
   * Sets the stitch parameters for embroidery.
   * @method setStitch
   * @for p5
   * @param {Number} minLength - Minimum stitch length in millimeters
   * @param {Number} desiredLength - Desired stitch length in millimeters
   * @param {Number} noise - Amount of random variation in stitch length (0-1)
   * @example
   * 
   * 
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   setStitch(1, 3, 0.2); // min 1mm, desired 3mm, 20% noise
   *   // Draw embroidery patterns
   * }
   * 
   * 
   */
  p5embroidery.setStitch = function (minLength, desiredLength, noise) {
    _embrSettings.minStitchLength = Math.max(0, minLength);
    _embrSettings.stitchLength = Math.max(0.1, desiredLength);
    _embrSettings.resampleNoise = Math.min(1, Math.max(0, noise));
  };

  /**
   * Sets the draw mode for embroidery.
   * @method setDrawMode
   * @for p5
   * @param {String} mode - The draw mode to set ('stitch', 'p5', 'realistic')
   * @example
   * 
   * 
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   setDrawMode('stitch'); // Show stitch points and lines
   *   // Draw embroidery patterns
   * }
   * 
   * 
   */
  p5embroidery.setDrawMode = function (mode) {
    _drawMode = mode;
  };

  /**
   * Converts a line segment into a series of stitches.
   * @private
   * @param {number} x1 - Starting x-coordinate
   * @param {number} y1 - Starting y-coordinate
   * @param {number} x2 - Ending x-coordinate
   * @param {number} y2 - Ending y-coordinate
   * @returns {Array&lt;{x: number, y: number}>} Array of stitch points in 0.1mm units
   */
  function convertLineToStitches(x1, y1, x2, y2) {
    console.log("Converting line to stitches (before offset):", {
      from: { x: x1, y: y1 },
      to: { x: x2, y: y2 },
    });

    console.log("Converting line to stitches", {
      from: { x: x1, y: y1 },
      to: { x: x2, y: y2 },
    });

    let stitches = [];
    let dx = x2 - x1;
    let dy = y2 - y1;
    let distance = Math.sqrt(dx * dx + dy * dy);

    console.log("Line properties:", {
      dx,
      dy,
      distance,
      minStitchLength: _embrSettings.minStitchLength,
      stitchLength: _embrSettings.stitchLength,
    });

    // Add first stitch at starting point
    stitches.push({
      x: x1 * 10,
      y: y1 * 10,
    });

    // If distance is less than minimum stitch length, we're done
    if (distance &lt; _embrSettings.minStitchLength) {
      return stitches;
    }

    let baseStitchLength = _embrSettings.stitchLength;
    let numStitches = Math.floor(distance / baseStitchLength);
    let currentDistance = 0;

    // Handle full-length stitches
    for (let i = 0; i &lt; numStitches; i++) {
      // Add noise to stitch length if specified
      let stitchLength = baseStitchLength;
      if (_embrSettings.resampleNoise > 0) {
        let noise = (Math.random() * 2 - 1) * _embrSettings.resampleNoise;
        stitchLength *= 1 + noise;
      }

      // update cumulative distance
      currentDistance += stitchLength;
      let t = Math.min(currentDistance / distance, 1);

      stitches.push({
        x: (x1 + dx * t) * 10,
        y: (y1 + dy * t) * 10,
      });
    }

    // Add final stitch at end point if needed
    let remainingDistance = distance - currentDistance;
    if (
      remainingDistance > _embrSettings.minStitchLength ||
      numStitches === 0
    ) {
      stitches.push({
        x: x2 * 10,
        y: y2 * 10,
      });
    }

    console.log("Generated stitches:", stitches);
    return stitches;
  }

  /**
   * Exports the recorded embroidery data as a file.
   * @method exportEmbroidery
   * @for p5
   * @param {String} filename - Output filename with extension
   * @example
   * 
   * 
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   // Draw embroidery patterns
   *   endRecord();
   *   exportEmbroidery('pattern.dst');
   * }
   * 
   * 
   */
  p5embroidery.exportEmbroidery = function (filename) {
    const extension = filename.split(".").pop().toLowerCase();

    switch (extension) {
      case "dst":
        p5embroidery.exportDST(filename);
        break;
      default:
        console.error(`Unsupported embroidery format: ${extension}`);
        break;
    }
  };

  /**
   * Exports the recorded embroidery data as a G-code file.
   * @method exportGcode
   * @for p5
   * @param {String} filename - Output filename
   * @example
   * 
   * 
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   // Draw embroidery patterns
   *   endRecord();
   *   exportGcode('pattern.gcode');
   * }
   * 
   * 
   */
  p5embroidery.exportGcode = function (filename) {
    const points = [];
    for (const thread of _stitchData.threads) {
      for (const run of thread.runs) {
        for (const stitch of run) {
          points.push({
            x: stitch.x,
            y: stitch.y,
          });
        }
      }
    }

    const gcodeWriter = new GCodeWriter();
    gcodeWriter.addComment("Embroidery Pattern");
    gcodeWriter.move(points[0].x, points[0].y);
    for (const point of points) {
      gcodeWriter.move(point.x, point.y);
    }
    gcodeWriter.saveGcode(points, "EmbroideryPattern", filename);
  };

  /**
   * Exports the recorded embroidery data as a DST file.
   * @method exportDST
   * @for p5
   * @param {String} [filename='embroideryPattern.dst'] - Output filename
   * @example
   * 
   * 
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   // Draw embroidery patterns
   *   endRecord();
   *   exportDST('pattern.dst');
   * }
   * 
   * 
   */
  p5embroidery.exportDST = function (filename = "embroideryPattern.dst") {
    const points = [];
    const dstWriter = new DSTWriter();

    console.log("=== Starting DST Export ===");
    console.log("Canvas size:", _stitchData.width, _stitchData.height);

    for (const thread of _stitchData.threads) {
      for (const run of thread.runs) {
        // Check if this is a thread trim command
        if (run.length === 1 &amp;&amp; run[0].command === "trim") {
          console.log("Trim command at:", run[0].x, run[0].y);
          points.push({
            x: 0,
            y: 0,
            jump: true,
            trim: true,
          });
          continue;
        }

        // Normal stitches
        console.log("=== New Stitch Run ===");
        for (const stitch of run) {
          console.log("Stitch point:", {
            original: { x: stitch.x / 10, y: stitch.y / 10 },
            dst: { x: stitch.x, y: stitch.y },
          });
          points.push({
            x: stitch.x,
            y: stitch.y,
          });
        }
      }
    }

    console.log("=== Final Points Array ===");
    console.log("First point:", points[0]);
    console.log("Last point:", points[points.length - 1]);

    dstWriter.saveDST(points, "EmbroideryPattern", filename);
  };

  /**
   * Inserts a thread trim command at the current position.
   * @method trimThread
   * @for p5
   * @example
   * 
   * 
   * function setup() {
   *   createCanvas(400, 400);
   *   beginRecord(this);
   *   line(10, 10, 50, 50);
   *   trimThread(); // Cut thread at current position
   *   line(60, 60, 100, 100);
   * }
   * 
   * 
   */
  p5embroidery.trimThread = function () {
    if (_recording) {
      // Get the current thread
      const currentThread = _stitchData.threads[_currentThreadIndex];
      
      // Get the last run in the current thread
      const lastRun = currentThread.runs[currentThread.runs.length - 1];
      
      // Get the last stitch position from the last run
      // Currently gets the FIRST stitch [0] of the last run, should be the LAST stitch
      let currentX = lastRun[0].x;
      let currentY = lastRun[0].y;
      
      // This should be changed to get the LAST stitch of the last run:
      let lastStitchIndex = lastRun.length - 1;
      currentX = lastRun[lastStitchIndex].x;
      currentY = lastRun[lastStitchIndex].y;
      
      // Add a special point to indicate thread trim
      _stitchData.threads[_currentThreadIndex].runs.push([
        {
          x: currentX,
          y: currentY,
          command: "trim", 
        },
      ]);

      if (_drawMode === "stitch") {
        // draw a scissors emoji at the trim point
        _p5Instance.push();
        _p5Instance.fill(0);
        // Draw 45 degree line
        let lineLength = 10; // Length of diagonal line in pixels
        let endX = mmToPixel(currentX/10) + lineLength;
        let endY = mmToPixel(currentY/10) - lineLength;
        _p5Instance.stroke(255,0,0); // red for line
        _p5Instance.strokeWeight(0.5);

        _originalLineFunc.call(_p5Instance, mmToPixel(currentX/10), mmToPixel(currentY/10), endX, endY);
        // Place scissors at end of line
        _p5Instance.text("✂️", endX, endY);
        _p5Instance.pop();
      }
    }
  };

  /**
   * Draws stitches according to the current draw mode
   * @param {Array} stitches - Array of stitch objects with x and y coordinates
   */
  function drawStitches(stitches) {
    let prevX = mmToPixel(stitches[0].x / 10);
    let prevY = mmToPixel(stitches[0].y / 10);

    if (_drawMode === "stitch") {
      // Draw stitch lines
      _p5Instance.push();

      for (let i = 1; i &lt; stitches.length; i++) {
        let currentX = mmToPixel(stitches[i].x / 10);
        let currentY = mmToPixel(stitches[i].y / 10);

        if (i === 0) {
          // Draw small dots at stitch points
          _p5Instance.stroke(255, 0, 0); // Red for stitch points
          _p5Instance.strokeWeight(3);
          _p5Instance.point(prevX, prevY);
        }

        _p5Instance.stroke(0); // Black for stitch lines
        _p5Instance.strokeWeight(1);
        _originalLineFunc.call(_p5Instance, prevX, prevY, currentX, currentY);

        // Draw small dots at stitch points
        _p5Instance.stroke(255, 0, 0); // Red for stitch points
        _p5Instance.strokeWeight(3);
        _p5Instance.point(currentX, currentY);

        prevX = currentX;
        prevY = currentY;
      }
      _p5Instance.pop();
    } else if (_drawMode === "realistic") {
      _p5Instance.push();
      _p5Instance.strokeCap(ROUND);

      // Draw background dots for thread ends
      _p5Instance.noStroke();
      _p5Instance.fill(255); // White background dots

      for (let i = 1; i &lt; stitches.length; i++) {
        let currentX = mmToPixel(stitches[i].x / 10);
        let currentY = mmToPixel(stitches[i].y / 10);
        _originalEllipseFunc.call(_p5Instance, currentX, currentY, 3); // Small white dots at stitch points

        // Draw three layers of lines with different weights and colors
        // Dark bottom layer
        _p5Instance.stroke(0); // Black
        _p5Instance.strokeWeight(2.5);

        _originalLineFunc.call(_p5Instance, prevX, prevY, currentX, currentY);

        // Middle layer
        _p5Instance.stroke(80); // Dark gray
        _p5Instance.strokeWeight(1.8);
        _originalLineFunc.call(_p5Instance, prevX, prevY, currentX, currentY);

        // Top highlight layer
        _p5Instance.stroke(160); // Light gray
        _p5Instance.strokeWeight(1);
        _originalLineFunc.call(_p5Instance, prevX, prevY, currentX, currentY);
        prevX = currentX;
        prevY = currentY;
      }

      _p5Instance.pop();
    } else if (_drawMode === "p5") {
      // For p5 mode, we need to draw a line from the starting point to each stitch
      if (stitches.length > 0) {
        // prevX and prevY are already in mm, but we need to convert them to pixels
        // For each stitch, draw a line from the previous point
        for (let i = 1; i &lt; stitches.length; i++) {
          // Convert stitch coordinates from tenths of mm to pixels
          const currentX = mmToPixel(stitches[i].x / 10);
          const currentY = mmToPixel(stitches[i].y / 10);
          
          _originalLineFunc.call(
            _p5Instance,
            prevX,
            prevY,
            currentX,
            currentY
          );
          
          // Update the previous point
          prevX = currentX;
          prevY = currentY;
        }
      }
    }

    // Return the last stitch position for chaining
    return stitches.length > 0
      ? {
          x: stitches[stitches.length - 1].x / 10,
          y: stitches[stitches.length - 1].y / 10,
        }
      : { x: startX, y: startY };
  }

  // Expose public functions
  global.p5embroidery = p5embroidery;
  global.beginRecord = p5embroidery.beginRecord;
  global.endRecord = p5embroidery.endRecord;
  global.exportEmbroidery = p5embroidery.exportEmbroidery;
  global.exportDST = p5embroidery.exportDST;
  global.exportGcode = p5embroidery.exportGcode;
  global.trimThread = p5embroidery.trimThread; // Renamed from cutThread
  global.setStitch = p5embroidery.setStitch;
  global.setDrawMode = p5embroidery.setDrawMode;
  global.drawStitches = p5embroidery.drawStitches;
  global.mmToPixel = mmToPixel;
  global.pixelToMm = pixelToMm;
})(typeof globalThis !== "undefined" ? globalThis : window);

/**
 * Converts millimeters to pixels.
 * @method mmToPixel
 * @for p5
 * @param {Number} mm - Millimeters
 * @param {Number} [dpi=96] - Dots per inch
 * @return {Number} Pixels
 * @example
 * 
 * 
 * function setup() {
 *   let pixels = mmToPixel(10); // Convert 10mm to pixels
 *   console.log(pixels);
 * }
 * 
 * 
 */
function mmToPixel(mm, dpi = 96) {
  return (mm / 25.4) * dpi;
}

/**
 * Converts pixels to millimeters.
 * @method pixelToMm
 * @for p5
 * @param {Number} pixels - Pixels
 * @param {Number} [dpi=96] - Dots per inch
 * @return {Number} Millimeters
 * @example
 * 
 * 
 * function setup() {
 *   let mm = pixelToMm(100); // Convert 100 pixels to mm
 *   console.log(mm);
 * }
 * 
 * 
 */
function pixelToMm(pixels, dpi = 96) {
  return (pixels * 25.4) / dpi;
}
</code></pre></article></section></div></div></div><div class="search-container" id="PkfLWpAbet" style="display:none"><div class="wrapper" id="iCxFxjkHbP"><button class="icon-button search-close-button" id="VjLlGakifb" aria-label="close search"><svg><use xlink:href="#close-icon"></use></svg></button><div class="search-box-c"><svg><use xlink:href="#search-icon"></use></svg> <input type="text" id="vpcKVYIppa" class="search-input" placeholder="Search..." autofocus></div><div class="search-result-c" id="fWwVHRuDuN"><span class="search-result-c-text">Type anything to view search result</span></div></div></div><div class="mobile-menu-icon-container"><button class="icon-button" id="mobile-menu" data-isopen="false" aria-label="menu"><svg><use xlink:href="#menu-icon"></use></svg></button></div><div id="mobile-sidebar" class="mobile-sidebar-container"><div class="mobile-sidebar-wrapper"><div class="mobile-nav-links"></div><div class="mobile-sidebar-items-c"><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-classes"><div>Classes</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="DSTWriter.html">DSTWriter</a></div></div><div class="sidebar-section-title with-arrow" data-isopen="false" id="sidebar-global"><div>Global</div><svg><use xlink:href="#down-icon"></use></svg></div><div class="sidebar-section-children-container"><div class="sidebar-section-children"><a href="global.html#beginRecord">beginRecord</a></div><div class="sidebar-section-children"><a href="global.html#endRecord">endRecord</a></div><div class="sidebar-section-children"><a href="global.html#exportDST">exportDST</a></div><div class="sidebar-section-children"><a href="global.html#exportEmbroidery">exportEmbroidery</a></div><div class="sidebar-section-children"><a href="global.html#exportGcode">exportGcode</a></div><div class="sidebar-section-children"><a href="global.html#mmToPixel">mmToPixel</a></div><div class="sidebar-section-children"><a href="global.html#pixelToMm">pixelToMm</a></div><div class="sidebar-section-children"><a href="global.html#setDrawMode">setDrawMode</a></div><div class="sidebar-section-children"><a href="global.html#setStitch">setStitch</a></div><div class="sidebar-section-children"><a href="global.html#trimThread">trimThread</a></div></div></div><div class="mobile-navbar-actions"><div class="navbar-right-item"><button class="icon-button search-button" aria-label="open-search"><svg><use xlink:href="#search-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button theme-toggle" aria-label="toggle-theme"><svg><use class="theme-svg-use" xlink:href="#light-theme-icon"></use></svg></button></div><div class="navbar-right-item"><button class="icon-button font-size" aria-label="change-font-size"><svg><use xlink:href="#font-size-icon"></use></svg></button></div></div></div></div><script type="text/javascript" src="scripts/core.min.js"></script><script src="scripts/search.min.js" defer="defer"></script><script src="scripts/third-party/fuse.js" defer="defer"></script><script type="text/javascript">var tocbotInstance=tocbot.init({tocSelector:"#eed4d2a0bfd64539bb9df78095dec881",contentSelector:".main-content",headingSelector:"h1, h2, h3",hasInnerContainers:!0,scrollContainer:".main-content",headingsOffset:130,onClick:bringLinkToView})</script></body></html>